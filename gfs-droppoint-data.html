<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<!--
`gfs-droppoint-data`
A component for integrating with the GFS Drop Point API

@demo demo/index.html
-->

<dom-module id="gfs-droppoint-data">
  <template>
    <iron-ajax id='getDropPoints'
      debounce-duration="300"
      handle-as="json"
      method="GET"
      on-response="_newDropPointsAvailable"
      on-error="_dropPointDownloadError"
      content-type="application/json">
    </iron-ajax>
  </template>

  <script>
    Polymer({

      is: 'gfs-droppoint-data',

      properties: {
        jwt: {
          type: String,
          value: ''
        },
        baseUrl: {
          type: String,
          value: 'https://api.justshoutgfs.com/droppoints',
        },
      },
      observers: [
        '_updateDropPoints(jwt, baseUrl)'
      ],
      _updateDropPoints: function(token, url) {
        if(token === "" ||
            url === "")
            return;

        var server = this.$.getDropPoints;
        server.headers = this._createBearerToken();

        server.url = url;

        this.fire('startedloading', {});

        server.generateRequest();
      },
      _dropPointDownloadError: function(e) {
        var req = e.detail.request;

        switch(req.status)
        {
          case 401:
            this.fire('authenticationerror', {error:{reason: "notAuthenticated"}});
            break;
          case 403:
            this.fire('authenticationerror', {error:{reason: "forbidden"}});
            break;
          case 404:
          this.fire('loadingerror', {error:{reason: "notFound"}});
          default:
            this.fire('loadingerror', {error:{reason: "generalError"}});
            break;
        }

        var resp = e.detail.request.status;
      },
      _newDropPointsAvailable: function(e) {
        this.fire('completedloading', e.detail.response);
      },
      _createBearerToken: function() {
        return {"Authorization": "Bearer " + this.jwt};
      }
    });
  </script>
</dom-module>
